---
const apiBase = Astro.props.apiBase;
const statuses = ['draft', 'sent', 'paid', 'overdue'];
---
<section class="card space-y-6">
  <div>
    <h3 class="text-lg font-semibold text-slate-900">Acciones rapidas</h3>
    <p class="text-sm text-slate-500">Crea clientes e impacta nuevas facturas sin salir del dashboard.</p>
  </div>
  <div class="grid gap-6 md:grid-cols-2">
    <form class="space-y-3" data-action="/customers">
      <h4 class="text-sm font-semibold text-slate-700">Nuevo cliente</h4>
      <div>
        <label>Nombre completo</label>
        <input name="name" placeholder="Maria Lopez" required />
      </div>
      <div>
        <label>Correo</label>
        <input type="email" name="email" placeholder="correo@cliente.com" required />
      </div>
      <div>
        <label>RFC / NIT</label>
        <input name="taxId" placeholder="RFC123" required />
      </div>
      <div>
        <label>Telefono</label>
        <input name="phone" placeholder="555-123-4567" />
      </div>
      <div>
        <label>Direccion</label>
        <textarea name="address" rows="2" placeholder="Calle 123, Ciudad" required></textarea>
      </div>
      <p class="text-xs text-slate-500" data-feedback="customer"></p>
      <button type="submit">Guardar cliente</button>
    </form>

    <form class="space-y-3" data-action="/invoices">
      <h4 class="text-sm font-semibold text-slate-700">Nueva factura</h4>
      <div>
        <label>ID del cliente</label>
        <input name="customerId" type="number" min="1" placeholder="1" required />
      </div>
      <div>
        <label>Descripcion</label>
        <input name="description" placeholder="Servicios de consultoria" required />
      </div>
      <div>
        <label>Monto total (MXN)</label>
        <input name="total" type="number" min="0" step="0.01" placeholder="2500" required />
      </div>
      <div>
        <label>Estatus</label>
        <select name="status">
          {statuses.map((status) => (
            <option value={status} key={status}>{status}</option>
          ))}
        </select>
      </div>
      <div class="grid gap-3 md:grid-cols-2">
        <div>
          <label>Fecha de emision</label>
          <input name="issueDate" type="date" required />
        </div>
        <div>
          <label>Fecha de vencimiento</label>
          <input name="dueDate" type="date" required />
        </div>
      </div>
      <p class="text-xs text-slate-500" data-feedback="invoice"></p>
      <button type="submit">Registrar factura</button>
    </form>
  </div>
</section>

<script type="module" define:vars={{ apiBase }}>
  const forms = document.querySelectorAll('form[data-action]');
  const jsonFields = ['customerId', 'total'];

  const getAuthHeaders = () => {
    const token = localStorage.getItem('authToken');
    const headers = { 'Content-Type': 'application/json' };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }
    return headers;
  };

  forms.forEach((form) => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const feedback = form.querySelector('[data-feedback]');
      if (feedback) {
        feedback.textContent = 'Enviando...';
        feedback.classList.remove('text-red-500', 'text-green-600');
      }
      const data = {};
      new FormData(form).forEach((value, key) => {
        if (jsonFields.includes(key)) {
          data[key] = Number(value);
        } else {
          data[key] = value;
        }
      });
      try {
        const response = await fetch(`${apiBase}${form.dataset.action}`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          const body = await response.json().catch(() => ({}));
          throw new Error(body.message || 'No se pudo completar la accion');
        }
        form.reset();
        if (feedback) {
          feedback.textContent = 'Listo! Refresca el dashboard para ver los cambios.';
          feedback.classList.remove('text-red-500');
          feedback.classList.add('text-green-600');
        }
      } catch (error) {
        if (feedback) {
          feedback.textContent = error.message;
          feedback.classList.add('text-red-500');
        }
      }
    });
  });
</script>
