---
const apiBase = Astro.props.apiBase;
---
<section class="card space-y-4">
  <div>
    <h3 class="text-lg font-semibold text-slate-900">Autenticacion</h3>
    <p class="text-sm text-slate-500">Inicia sesion para obtener un token JWT y habilitar las acciones protegidas.</p>
  </div>
  <form class="space-y-3" data-auth-form>
    <div>
      <label>Correo</label>
      <input type="email" name="email" placeholder="admin@example.com" required />
    </div>
    <div>
      <label>Contrasena</label>
      <input type="password" name="password" placeholder="********" required />
    </div>
    <button type="submit">Ingresar</button>
    <p class="text-xs text-slate-500" data-auth-status>Tu token se guardara en el navegador al iniciar sesion.</p>
  </form>
</section>

<script type="module" define:vars={{ apiBase }}>
  const form = document.querySelector('[data-auth-form]');
  const status = document.querySelector('[data-auth-status]');

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    status.textContent = 'Autenticando...';
    status.classList.remove('text-red-500', 'text-green-600');
    const formData = new FormData(form);
    try {
      const response = await fetch(`${apiBase}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: formData.get('email'),
          password: formData.get('password')
        })
      });
      if (!response.ok) {
        const body = await response.json().catch(() => ({}));
        throw new Error(body.message || 'Credenciales invalidas');
      }
      const data = await response.json();
      localStorage.setItem('authToken', data.token);
      if (data.usuario) {
        localStorage.setItem('authUser', JSON.stringify(data.usuario));
      }
      status.textContent = `Token guardado. Rol: ${data.usuario?.role || 'no informado'}. Ya puedes usar las acciones protegidas.`;
      status.classList.add('text-green-600');
    } catch (error) {
      status.textContent = error.message;
      status.classList.add('text-red-500');
    }
  });
</script>
